<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loop Export Preview</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }
        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            flex: 1;
        }
        .status {
            font-size: 13px;
            color: #8b949e;
        }
        .status.loaded { color: #3fb950; }
        .status.waiting { color: #d29922; }
        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 64px 32px 32px;
        }
        .markdown-body {
            background: #0d1117;
            padding: 32px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .markdown-body img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
        }
        .waiting-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }
        .waiting-screen h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .waiting-screen p {
            color: #8b949e;
            margin: 4px 0;
        }
        .pulse {
            width: 12px;
            height: 12px;
            background: #d29922;
            border-radius: 50%;
            margin: 24px auto;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        /* GitHub alert styling */
        .markdown-body blockquote {
            border-left-color: #30363d;
        }
        .markdown-body blockquote p:first-child {
            font-weight: 500;
        }
        /* Dark mode overrides for github-markdown-css */
        .markdown-body {
            color-scheme: dark;
            --color-prettylights-syntax-comment: #8b949e;
            --color-prettylights-syntax-constant: #79c0ff;
            --color-prettylights-syntax-entity: #d2a8ff;
            --color-prettylights-syntax-storage-modifier-import: #c9d1d9;
            --color-prettylights-syntax-entity-tag: #7ee787;
            --color-prettylights-syntax-keyword: #ff7b72;
            --color-prettylights-syntax-string: #a5d6ff;
            --color-prettylights-syntax-variable: #ffa657;
            --color-fg-default: #c9d1d9;
            --color-fg-muted: #8b949e;
            --color-fg-subtle: #6e7681;
            --color-canvas-default: #0d1117;
            --color-canvas-subtle: #161b22;
            --color-border-default: #30363d;
            --color-border-muted: #21262d;
            --color-neutral-muted: rgba(110,118,129,0.4);
            --color-accent-fg: #58a6ff;
            --color-accent-emphasis: #1f6feb;
            --color-danger-fg: #f85149;
        }
        .markdown-body code {
            background: #161b22;
        }
        .markdown-body pre {
            background: #161b22;
        }
        .markdown-body table tr {
            background: #0d1117;
            border-top: 1px solid #21262d;
        }
        .markdown-body table tr:nth-child(2n) {
            background: #161b22;
        }
        .markdown-body table td, .markdown-body table th {
            border: 1px solid #30363d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Loop Export Preview</h1>
        <div id="status" class="status {{if .HasContent}}loaded{{else}}waiting{{end}}">
            {{if .HasContent}}
                {{.TarFile}} loaded at {{.LoadedAt}}
            {{else}}
                Waiting for tar file...
            {{end}}
        </div>
    </div>

    <div class="container">
        {{if .HasContent}}
        <article id="content" class="markdown-body"></article>
        {{else}}
        <div class="waiting-screen">
            <h2>Waiting for Loop export</h2>
            <p>Drop a Loop export <code>.tar</code> file into this directory</p>
            <p>The preview will load automatically</p>
            <div class="pulse"></div>
        </div>
        {{end}}
    </div>

    <script>
        "use strict";
        
        {{if .HasContent}}
        (function() {
            fetch("/content")
                .then(function(r) {
                    if (!r.ok) { throw new Error("Failed to load content"); }
                    return r.text();
                })
                .then(function(md) {
                    marked.setOptions({
                        gfm: true,
                        breaks: false,
                        pedantic: false
                    });
                    document.getElementById("content").innerHTML = marked.parse(md);
                })
                .catch(function(err) {
                    document.getElementById("content").innerHTML = "<p>Error loading content: " + err + "</p>";
                });
        })();
        {{else}}
        (function() {
            setInterval(function() {
                fetch("/api/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.loaded) {
                            location.reload();
                        }
                    })
                    .catch(function() { /* ignore polling errors */ });
            }, 2000);
        })();
        {{end}}
    </script>
</body>
</html>
